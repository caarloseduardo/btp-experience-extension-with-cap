# ExercÃ­cio 1 - IntroduÃ§Ã£o ao CAP

Neste exercÃ­cio, vocÃª construirÃ¡ um pequeno aplicativo com SAP Cloud Application Programming Model (CAP).

VocÃª usarÃ¡ esse cenÃ¡rio de aplicaÃ§Ã£o ao longo dos exercÃ­cios.
AlÃ©m disso, vocÃª se familiarizarÃ¡ com o CAP e a linguagem CDS.

O modelo de domÃ­nio conceitual para esta aplicaÃ§Ã£o _Gerenciamento de Incidentes_ Ã© o seguinte:

- *Clientes* podem criar *Incidentes* (diretamente ou por meio de agentes)
- *Incidentes* tÃªm tÃ­tulo, status e nÃ­vel de urgÃªncia
- *Incidentes* contÃªm um histÃ³rico de *Conversa* composto por diversas mensagens

<p>

![Modelo de domÃ­nio](assets/domain.drawio.svg)


## Crie um projeto

ğŸ‘‰ No SAP Business Application Studio, crie um novo _CAP Project_ por meio do assistente de projeto.
- Nomeie-o como `incidents-mgt`, por exemplo.
- Aceite o restante dos padrÃµes. Nenhum cÃ³digo de amostra Ã© necessÃ¡rio; vocÃª preencherÃ¡ o projeto conforme avanÃ§a.

<details>
<summary>Estas capturas de tela ajudam vocÃª a encontrar o assistente do projeto:</summary>

![Novo Projeto CAP](assets/BAS-NewProject.png)

![Novo projeto CAP - Detalhes](assets/BAS-NewProject-Details.png)

</details>
<p>

> VocÃª tambÃ©m pode criar o projeto com `cds init incidents-mgt` na linha de comando na pasta `/home/user/projects`.

## Adicionar incidentes

Agora vocÃª deveria ter mudado para um novo espaÃ§o de trabalho com o projeto criado.

ğŸ‘‰ Abra o explorador de arquivos novamente.

ğŸ‘‰ Crie um arquivo `data-model.cds` na pasta `db`.
- LÃ¡, adicione uma [entidade] `Incidents` (https://cap.cloud.sap/docs/cds/cdl#entities) com um campo-chave `ID` e um `title`.
- Escolha os tipos de dados apropriados. Use o preenchimento de cÃ³digo (intellisense) para escolher um tipo de dados adequado.
- AlÃ©m disso, adicione um namespace `incidents.mgt` ao inÃ­cio do arquivo, para que o nome completo da entidade seja `incidents.mgt.Incidents`

<details>
<summary>Ã‰ assim que deveria ser:</summary>

```cds
namespace incidents.mgt;

entity Incidents {
  key ID       : UUID;
  title        : String;
}
```
</details>

## Use aspectos predefinidos

A situaÃ§Ã£o dos campos-chave `ID` Ã© tÃ£o comum que existe um aspecto CDS prÃ©-construÃ­do disponÃ­vel chamado [`cuid`](https://cap.cloud.sap/docs/cds/common#aspect-cuid) que fornece exatamente isso .<br>
Ele pode ser importado com `using ... from '@sap/cds/common';` e usado em uma entidade com a sintaxe `:` (dois pontos).

AlÃ©m disso, a entidade `Incidents` deverÃ¡ conter informaÃ§Ãµes sobre quando foi criada e atualizada e por quem. Existe um [aspecto `managed` de `@sap/cds/common`](https://cap.cloud.sap/docs/cds/common#aspect-owned) que faz isso.

ğŸ‘‰ FaÃ§a uso dos dois aspectos e:
- Substitua o campo `ID` criado manualmente por [`cuid`](https://cap.cloud.sap/docs/cds/common#aspect-cuid)<br>
- Adicione o aspecto [`managed`](https://cap.cloud.sap/docs/cds/common#aspect-owned).


<details>
<summary>Ã‰ assim que deveria ser:</summary>

```cds
using { cuid, managed } from '@sap/cds/common';

namespace incidents.mgt;

entity Incidents : cuid, managed {
  title        : String;
}
```
</details>

<p>

ğŸ‘‰ Reserve alguns momentos e confira o que o pacote `@sap/cds/common` tem a oferecer adicionalmente. No editor, segure <kbd>Ctrl</kbd> (ou <kbd>âŒ˜</kbd>) e passe o mouse sobre o texto `managed`. Clique para navegar por dentro.
Consulte a [documentaÃ§Ã£o](https://cap.cloud.sap/docs/cds/common) para saber mais.


## Adicione um histÃ³rico de conversa

Um incidente deve conter uma sÃ©rie de mensagens para construir um histÃ³rico de conversaÃ§Ã£o.

Para criar esse relacionamento, o **modelador grÃ¡fico de CDS** no SAP Business Application Studio Ã© uma Ã³tima ferramenta.<br>
ğŸ‘‰ Abra-o para o arquivo `data-model.cds` usando uma das duas opÃ§Ãµes:
- Clique com o botÃ£o direito no arquivo `data-model.cds`. Selecione `Abrir com` > `Modelador grÃ¡fico CDS`
- Ou abra o modelador atravÃ©s do projeto **Storyboard**:
   - Pressione <kbd>F1</kbd> > `Abrir Storyboard`
   - Clique na entidade `Incidents` > `Abrir no Modelador GrÃ¡fico`

ğŸ‘‰ Em sua tela, adicione uma entidade `Conversas`.
- Na aba `Aspects` da folha de propriedades, adicione o campo-chave `ID` do aspecto CDS `cuid`.
- Adicione os campos `timestamp`, `author` e `message` com os tipos apropriados.

ğŸ‘‰ Agora **conecte** as duas entidades.
- Passe o mouse sobre a entidade `Incidents` e encontre o botÃ£o `Adicionar Relacionamento` no menu suspenso. Arraste-o **de** `Incidents` **para** a entidade `Conversations`.
- Na caixa de diÃ¡logo `Novo Relacionamento`:
   - Escolha um tipo de relacionamento para que sempre que uma instÃ¢ncia de `Incident` for excluÃ­da, todas as suas conversas tambÃ©m sejam excluÃ­das.
   - Fique com os campos propostos de `conversations` e `incidents`.


<details>
<summary>Resumindo, as entidades ficarÃ£o assim:</summary>

![Entidades de incidentes e conversas no modelador grÃ¡fico](assets/Incidents-Conversations-graphical.png)

Como texto, fica assim. Observe a `ComposiÃ§Ã£o` entre as duas entidades.

```cds
using { cuid, managed } from '@sap/cds/common';

namespace incidents.mgt;

entity Incidents : cuid, managed {
  title         : String(100);
  conversations : Composition of many Conversations on conversations.incidents = $self;
}

entity Conversations : cuid, managed {
  timestamp : DateTime;
  author    : String(100);
  message   : String;
  incidents : Association to Incidents;
}
```

</details>

> Para abrir o editor de cÃ³digo, basta clicar duas vezes no arquivo `db/data-model.cds` na Ã¡rvore do explorador.

<!-- > Nos exercÃ­cios a seguir, sinta-se Ã  vontade para usar o modelador grÃ¡fico ou o editor de cÃ³digo como desejar. Descubra o que funciona para vocÃª.<br>
PorÃ©m nas soluÃ§Ãµes imprimiremos a forma textual, pois Ã© mais conveniente copiar/colar. -->


## Adicionar status e urgÃªncia

Os incidentes deverÃ£o ter mais dois campos `status` e `urgency`, que sÃ£o 'listas de cÃ³digos', ou seja, dados de configuraÃ§Ã£o.

ğŸ‘‰ Adicione duas entidades, usando o aspecto [`sap.common.CodeList`](https://cap.cloud.sap/docs/cds/common#aspect-codelist).
- `Status` para o status do incidente como _new_, _in process_ etc.
  - Nomeie seu campo-chave como `code` em vez de `ID`.
- `Urgency` para denotar a prioridade como _high_, _medium_ etc.
  - Nomeie seu campo-chave como `code` em vez de `ID`.

ğŸ‘‰ Adicione uma [associaÃ§Ã£o](https://cap.cloud.sap/docs/guides/domain-modeling#associations) a `Incidents` apontando para cada nova entidade. As associaÃ§Ãµes devem ser apenas _unidirecionais_, ou seja, apontando _de_ `Incidents` para `Status` ou `Urgency`, mas nÃ£o na outra direÃ§Ã£o.

<details>
<summary>Veja o resultado:</summary>

Em `db/data-model.cds`, adicione:

```cds
using { sap.common.CodeList } from '@sap/cds/common';

entity Status : CodeList {
  key code  : String;
}

entity Urgency : CodeList {
  key code : String;
}

entity Incidents {
  ...
  urgency       : Association to Urgency;
  status        : Association to Status;
};
```

</details>

## Crie um serviÃ§o CDS

Deve haver uma API para processadores de incidentes para manter incidentes.

ğŸ‘‰ Em um novo arquivo `srv/processor-service.cds`, crie um [serviÃ§o CDS](https://cap.cloud.sap/docs/cds/cdl#service-definitions) que expÃµe um um para um projeÃ§Ã£o em `Incidents`.<br>

<details>
<summary>Ã‰ assim que o serviÃ§o deveria ser:</summary>

```cds
using { incidents.mgt } from '../db/data-model';

service ProcessorService {

  entity Incidents as projection on mgt.Incidents;

}
```

</details>

## Inicie o aplicativo

ğŸ‘‰ Execute o aplicativo:
- Abra um terminal. Pressione <kbd>F1</kbd>, digite _new terminal_ ou use o menu principal.
- No terminal, execute na pasta raiz do projeto:

   ```sh
    cds watch
   ```

   <details>
   <summary>Veja a saÃ­da do console:</summary>

   ![Iniciar aplicativo, saÃ­da do terminal](assets/StartApp-Terminal.png)
   </details>

   <p>

Reserve um momento e verifique o resultado do que estÃ¡ acontecendo:

- A aplicaÃ§Ã£o consiste em trÃªs arquivos `cds`. Duas sÃ£o fontes de aplicativos e uma vem da biblioteca `@sap/cds`:
  ```sh
  [cds] - loaded model from 3 file(s):

    srv/processor-service.cds
    db/data-model.cds
    .../@sap/cds/common.cds
  ```

- Um [banco de dados SQLite] na memÃ³ria (https://cap.cloud.sap/docs/guides/databases-sqlite) foi criado. Ele contÃ©m os dados do aplicativo (que ainda nÃ£o temos).
  ```sh
  [cds] - connect to db > sqlite { database: ':memory:' }
  /> successfully deployed to in-memory database.
  ```

- O serviÃ§o CDS foi exposto neste caminho:
  ```sh
  [cds] - serving ProcessorService { path: '/odata/v4/processor' }
  ```


ğŸ‘‰ Agora <kbd>Ctrl+Clique</kbd> no link `http://localhost:4004` no terminal.
- No SAP Business Application Studio, esse URL Ã© automaticamente transformado em um endereÃ§o como `https://port4004-workspaces-ws-...applicationstudio.cloud.sap/`
- Se vocÃª trabalha localmente, seria http://localhost:4004.

Na pÃ¡gina de Ã­ndice, todos os terminais sÃ£o listados junto com as entidades que eles expÃµem.

![PÃ¡gina de Ã­ndice com lista de endpoints e entidades](assets/IndexPage.png)

O link _Fiori preview_ vocÃª usarÃ¡ mais tarde.

ğŸ‘‰ VocÃª sabe por que o caminho da URL do serviÃ§o Ã© `/processor`? Qual Ã© o link `$metadata`?

<details>
<summary>Aqui estÃ¡ o porquÃª:</summary>

VocÃª nomeou o serviÃ§o CDS como `ProcessorService`, e o sistema de tempo de execuÃ§Ã£o infere a URL `processor` removendo `Service`. VocÃª pode configurar isso explicitamente usando a [anotaÃ§Ã£o `@path`](https://cap.cloud.sap/docs/node.js/cds-serve#path).

A URL `$metadata` fornece o documento de metadados necessÃ¡rio para o [protocolo OData](https://cap.cloud.sap/docs/advanced/odata). Em breve vocÃª verÃ¡ o OData em aÃ§Ã£o.

</details>

## Adicionar dados de exemplo

Adicione alguns dados de teste para trabalhar.

ğŸ‘‰ Crie **arquivos csv** vazios para todas as entidades. Em um novo terminal, execute:

```sh
cds add data
```


Assim que eles estiverem lÃ¡, o `cds watch` os localiza e os implanta no banco de dados. Verifique a saÃ­da do console:

```sh
[cds] - connect to db > sqlite { database: ':memory:' }
> init from db/data/incidents.mgt-Urgency.texts.csv
> init from db/data/incidents.mgt-Urgency.csv
> init from db/data/incidents.mgt-Status.texts.csv
> init from db/data/incidents.mgt-Status.csv
> init from db/data/incidents.mgt-Incidents.csv
> init from db/data/incidents.mgt-Conversations.csv
```

> Observe como os nomes dos arquivos correspondem aos nomes das entidades.

Agora preencha algum conteÃºdo:

ğŸ‘‰ Para as duas listas de cÃ³digos, **adicione registros csv no terminal** bem rÃ¡pido:

```sh
cat << EOF > db/data/incidents.mgt-Status.csv
code,name
N,New
I,In Process
C,Closed
EOF

cat << EOF > db/data/incidents.mgt-Urgency.csv
code,name
H,High
M,Medium
L,Low
EOF
```

ğŸ‘‰ Para os arquivos csv `Incidents` e `Conversations`, use o **editor de dados de exemplo** para preencher alguns dados.
- Clique duas vezes no arquivo `db/data/incidents.mgt-Incidents.csv` na Ã¡rvore do explorador.
- No editor, adicione talvez 10 linhas. Utilize o campo `NÃºmero de linhas` e clique em `Adicionar` para criar os registros.
- Crie tambÃ©m registros para o arquivo `db/data/incidents.mgt-Conversations`. O editor preenche automaticamente a chave estrangeira `incidents_ID`.

ğŸ‘‰ Na pÃ¡gina de Ã­ndice dos aplicativos, clique no link `Incidents` que executa uma solicitaÃ§Ã£o `GET /odata/v4/processor/Incidents`.<br>


## Adicione uma UI simples

ğŸ‘‰ Clique em _Incidents_ > _[Fiori Preview](https://cap.cloud.sap/docs/advanced/fiori#sap-fiori-preview)_ na pÃ¡gina de Ã­ndice da aplicaÃ§Ã£o. Isso abre um aplicativo SAP Fiori Elements que foi criado dinamicamente. Ele exibe os dados da entidade em uma lista.

A lista parece estar vazia embora existam dados disponÃ­veis. Isso ocorre porque nenhuma coluna estÃ¡ configurada. Vamos mudar isso.

ğŸ‘‰ Adicione um arquivo `app/annotations.cds` com este conteÃºdo:

```cds
using { ProcessorService as service } from '../srv/processor-service';

// enable drafts for editing in the UI
annotate service.Incidents with @odata.draft.enabled;

// table columns in the list
annotate service.Incidents with @UI : {
  LineItem  : [
    { $Type : 'UI.DataField', Value : title},
    { $Type : 'UI.DataField', Value : modifiedAt },
    { $Type : 'UI.DataField', Value : status.name, Label: 'Status' },
    { $Type : 'UI.DataField', Value : urgency.name, Label: 'Urgency' },
  ],
};

// title in object page
annotate service.Incidents with @(
    UI.HeaderInfo : {
      Title : {
        $Type : 'UI.DataField',
        Value : title,
      },
      TypeName : 'Incident',
      TypeNamePlural : 'Incidents',
      TypeImageUrl : 'sap-icon://alert',
    }
);
```

que cria 3 colunas:

![PÃ¡gina da lista Fiori com 3 colunas](assets/Fiori-simple.png)

Existe atÃ© um rÃ³tulo prÃ©-configurado para a coluna `modifiedAt`.<br>
ğŸ‘‰ VocÃª sabe como procurÃ¡-los? Dica: use os recursos do editor.

<details>
<summary>Veja como:</summary>

No aspecto `managed` em `db/data-model.cds`, selecione _Ir para ReferÃªncias_ no menu de contexto. Expanda `common.cds` na Ã¡rvore Ã  direita e verifique as entradas `annotate managed` atÃ© ver as anotaÃ§Ãµes `@title`:

![DiÃ¡logo com todas as referÃªncias do aspecto gerenciado](assets/Editor-GoToReferences.png)

Os textos atuais sÃ£o obtidos de um pacote de recursos que Ã© endereÃ§ado com uma chave `{i18n>...}`. Consulte o [guia de localizaÃ§Ã£o](https://cap.cloud.sap/docs/guides/i18n) para saber como isso funciona.

</details>

<p>

O rÃ³tulo da coluna `title` parece estar errado.<br>
ğŸ‘‰ Corrija-o adicionando a [anotaÃ§Ã£o CDS](https://cap.cloud.sap/docs/advanced/fiori#prefer-title-and-description) apropriada ao elemento `Incidents.title`.

<details>
<summary>Ã‰ assim que vocÃª pode fazer isso:</summary>

Adicione uma anotaÃ§Ã£o `@title:'Title'` Ã  definiÃ§Ã£o de `Incidents`. Certifique-se de colocÃ¡-lo corretamente antes do ponto e vÃ­rgula. Cuidado com erros de sintaxe.

```cds
entity Incidents : cuid, managed {
  title         : String(100) @title : 'Title';   // <--
  ...
}
```

Observe que as anotaÃ§Ãµes podem ser adicionadas em [locais diferentes na sintaxe do CDS](https://cap.cloud.sap/docs/cds/cdl#annotations).

</details>

## Adicionar lÃ³gica de negÃ³cios

Vamos adicionar um pouco de lÃ³gica ao aplicativo. Quando um incidente Ã© criado com _urgent_ no tÃ­tulo, sua urgÃªncia deve ser definida como 'Alta'.

ğŸ‘‰ Adicione um arquivo `srv/processor-service.js` com este conteÃºdo:

```js
const cds = require('@sap/cds')

class ProcessorService extends cds.ApplicationService {
  async init() {

    this.before('CREATE', 'Incidents', ({ data }) => {
      if (data) {
        const incidents = Array.isArray(data) ? data : [data]
        incidents.forEach(incident => {
          // TODO add code here
        })
      }
    })

    return super.init()
  }
}

module.exports = ProcessorService
```

Observe como o arquivo `js` tem o mesmo nome do arquivo `cds`. Ã‰ assim que a estrutura encontra a implementaÃ§Ã£o. VocÃª pode ver isso na saÃ­da de `cds watch`, onde ele imprime o valor `impl`:

```sh
...
[cds] - serving ProcessorService { path: '/odata/v4/processor', impl: 'srv/processor-service.js' }
...
```

> NÃ£o vÃª o arquivo `js` listado lÃ¡? Verifique a ortografia!

ğŸ‘‰ Complete o cÃ³digo com a lÃ³gica real: verifique se o `title` inclui `urgent` e nesse caso defina seu `urgency code` para `H`.
- Trate `urgent` e `Urgent` da mesma maneira.
- TambÃ©m seja robusto caso nÃ£o haja tÃ­tulo atribuÃ­do.

<details>
<summary>SoluÃ§Ã£o:</summary>

```js
          if (incident.title?.toLowerCase().includes('urgent')) {
            incident.urgency = { code: 'H' }
          }
```
</details>

<p>

ğŸ‘‰ Agora teste a lÃ³gica criando um incidente por meio da UI. Adicione a palavra _urgent_ no tÃ­tulo. Depois de salvÃ¡-lo, volte para a lista. VocÃª deverÃ¡ ver a urgÃªncia definida como _High_.

## Depure o cÃ³digo (opcional)

Se vocÃª deseja depurar o cÃ³digo usando o depurador visual Javascript integrado, faÃ§a o seguinte:
- Elimine o processo `cds watch` em execuÃ§Ã£o.
- Pressione <kbd>F1</kbd>, digite _debug terminal_, selecione _Javascript: Debug Terminal_
- Neste terminal, inicie `cds watch` normalmente. O depurador Ã© iniciado e anexado a esse processo.
- Na parte superior, no meio da janela, veja o painel flutuante com o qual vocÃª pode controlar o depurador e realizar operaÃ§Ãµes passo a passo.<br>
   ![Controles do depurador](assets/DebuggerControls.png)
- Defina um ponto de interrupÃ§Ã£o na fonte dentro da funÃ§Ã£o `this.before(...`. FaÃ§a isso clicando duas vezes ao lado do nÃºmero da linha.<br>
   <detalhes>
   <summary>Pergunta rÃ¡pida: nesta situaÃ§Ã£o, por que o depurador nÃ£o pararia fora desta funÃ§Ã£o?</summary>

   Porque a funÃ§Ã£o `before()` Ã© um [manipulador de solicitaÃ§Ã£o](https://cap.cloud.sap/docs/node.js/core-services#srv-on-before-after), e Ã© apenas esse tipo de solicitaÃ§Ã£o- lidar com cÃ³digo que pode ser depurado agora.<br>
   O cÃ³digo acima e abaixo Ã© um cÃ³digo [bootstrap](https://cap.cloud.sap/docs/node.js/cds-server) que sÃ³ pode ser depurado se vocÃª definir o ponto de interrupÃ§Ã£o anteriormente ou fazer o depurador parar logo quando o processo do servidor Ã© iniciado.
   </detalhes>
- Agora crie um novo incidente. A UI congela porque o depurador foi interrompido.
- Para variÃ¡veis, pressione <kbd>F1</kbd>, digite _variables_, selecione _Run and Debug: Focus on Variables View_.
- Depois de inspecionar as variÃ¡veis, nÃ£o se esqueÃ§a de continuar a execuÃ§Ã£o usando o painel de controle de depuraÃ§Ã£o, caso contrÃ¡rio a UI do aplicativo nÃ£o reagirÃ¡ (e eventualmente atingirÃ¡ o tempo limite).

## Adicionar outro serviÃ§o

No serviÃ§o acima, vocÃª usou apenas a forma mÃ­nima de uma [projeÃ§Ã£o CDS](https://cap.cloud.sap/docs/cds/cdl#views-and-projections), que basicamente faz uma -uma exposiÃ§Ã£o de uma entidade Ã  superfÃ­cie da API:

```cds
service ProcessorService {
  entity Incidents as projection on mgt.Incidents;
}
```

No entanto, as projeÃ§Ãµes vÃ£o muito alÃ©m disso e fornecem meios poderosos para expressar consultas para cenÃ¡rios de aplicaÃ§Ã£o especÃ­ficos.
- Quando mapeadas para bancos de dados relacionais, tais projeÃ§Ãµes sÃ£o de fato traduzidas para visualizaÃ§Ãµes SQL.
- Em breve vocÃª verÃ¡ usos de projeÃ§Ãµes nÃ£o pertencentes ao banco de dados.

ğŸ‘‰ Agora explore projeÃ§Ãµes e serviÃ§os. Adicione um 'serviÃ§o de estatÃ­sticas' que mostre
- `Title` dos incidentes
- Seu `status`, mas mostrando `New` em vez de `N` etc. Dica: use uma [expressÃ£o de caminho](https://cap.cloud.sap/docs/cds/cql#path-expressions) para o `name`.
- Apenas incidentes urgentes. Dica: use uma [condiÃ§Ã£o `where`](https://cap.cloud.sap/docs/cds/cql).

O resultado estarÃ¡ disponÃ­vel em `/odata/v4/statistics/UrgentIncidents`. Qual Ã© o nome do serviÃ§o CDS que corresponde a este URL?

AlÃ©m disso, use o preenchimento de cÃ³digo do editor que o orienta ao longo da sintaxe.<br>

<details>
<summary>SoluÃ§Ã£o:</summary>

Em um arquivo `srv/statistics-service.cds` separado, adicione isto:

```cds
using { incidents.mgt } from '../db/data-model';

service StatisticsService {

  entity UrgentIncidents as projection on mgt.Incidents {
    title,                  // expose as-is
    status.name as status,  // expose with alias name using a path expression
  }
  where urgency.code = 'H'  // filter
}
```
</details>

<p>

ğŸ‘‰ Se vocÃª conseguiu isso, adicione estes campos com sintaxe mais avanÃ§ada:
- `modified` : uma string concatenada de `modifiedAt` e `modifiedBy` (use a sintaxe `str1 || str2`)
- `conversationCount` : uma contagem do nÃºmero de mensagens de conversa. Dica: SQL tem uma funÃ§Ã£o `count()`. NÃ£o se esqueÃ§a da clÃ¡usula `group by`.

<detalhes>
<summary>SoluÃ§Ã£o:</summary>

```cds
using { incidents.mgt } from '../db/data-model';

service StatisticsService {

  entity UrgentIncidents as projection on mgt.Incidents {
    title,                  // expose as-is
    status.name as status,  // expose with alias name using a path expression

    modifiedAt || ' (' || modifiedBy || ')' as modified          : String,
    count(conversations.ID)                 as conversationCount : Integer
  }
  where urgency.code = 'H' // filter
  group by ID              // needed for count()
}
```
</detalhes>

<p>

Verifique em `/odata/v4/statistics/UrgentIncidents` os resultados. Observe que eles irÃ£o variar dependendo dos dados da sua amostra.

Lembre-se: vocÃª tem todo esse poder sem uma Ãºnica linha de cÃ³digo (Javascript ou Java)!

## Testar recursos OData (opcional)

Vamos inspecionar alguns dos recursos integrados do [OData](https://cap.cloud.sap/docs/advanced/odata).

ğŸ‘‰ No navegador, anexe ao URL do serviÃ§o `.../odata/v4/processor/Incidents` para que vocÃª possa:
- listar incidentes
- com suas mensagens de conversa,
- limitar a lista a `5` entradas,
- mostrando apenas o campo `title`,
- classificando em ordem alfabÃ©tica ao longo do `title`

Como vocÃª pode fazer isso usando opÃ§Ãµes de consulta do [OData](https://cap.cloud.sap/docs/advanced/odata) como `$expand` etc.?
<detalhes>
<summary>Ã‰ assim:</summary>

Adicionar
```
?$select=title&$orderby=title&$top=5&$expand=conversations
```

para o URL.

</detalhes>

## Inspecione o banco de dados (opcional)

ApÃ³s a implantaÃ§Ã£o no banco de dados, o CAP cria instruÃ§Ãµes SQL DDL para criar tabelas e visualizaÃ§Ãµes para suas entidades.

ğŸ‘‰ No arquivo `db/data-model.cds`, selecione `CDS Preview > Preview as sql` no menu de contexto do editor. Isso abre um painel lateral com as instruÃ§Ãµes SQL.

<details>
<summary>Veja como fica:</summary>

![VisualizaÃ§Ã£o SQL para modelo de dados](assets/PreviewAsSQL.png)

</details>

<p>

ğŸ‘‰ VocÃª pode fazer o mesmo no terminal com
```sh
cds compile db --to sql
```

ğŸ‘‰ Agora faÃ§a o mesmo no arquivo `srv/statistics-service.cds`. O que hÃ¡ de diferente no resultado? VocÃª pode explicar de onde vÃªm as novas instruÃ§Ãµes SQL?

<details>
<summary>Ã‰ por isso:</summary>

Para cada projeÃ§Ã£o CDS, Ã© criada uma visualizaÃ§Ã£o SQL que captura as consultas das projeÃ§Ãµes. Ã‰ por isso que vocÃª vÃª muito mais instruÃ§Ãµes `CREATE VIEW`.

</details>

## Resumo

Agora vocÃª criou uma versÃ£o bÃ¡sica do aplicativo de gerenciamento de incidentes. Ainda assim, Ã© muito poderoso porque:

- ExpÃµe **APIs ricas** e metadados OData. VocÃª verÃ¡ clientes OData como SAP Fiori Elements UI em breve.
- Implanta em um **banco de dados pronto para uso**, incl. arquivos de dados.
- Vamos manter **concentrado no modelo de domÃ­nio** sem a necessidade de escrever cÃ³digo imperativo para solicitaÃ§Ãµes CRUD simples.
- MantÃ©m **arquivos padrÃ£o ao mÃ­nimo**. Basta contar os poucos arquivos do projeto.

Agora continue para o [exercÃ­cio 2](../ex2/README.md), onde vocÃª estenderÃ¡ o aplicativo com recursos remotos.